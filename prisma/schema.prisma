generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// üåç LAYER 0: GLOBAL IDENTITY
// ==========================================
model User {
  id         String     @id 
  email      String     @unique
  firstName  String
  lastName   String
  employments Employee[] 
  createdAt  DateTime   @default(now())
  archivedAt DateTime? 
}

// ==========================================
// üè• LAYER 1: TENANCY & ORG
// ==========================================
model Organization {
  id                     String    @id @default(uuid())
  name                   String
  settings               Json      @default("{}")
  archivedAt             DateTime? 
  departments            Department[]
  locations              Location[]
  roles                  EmployeeRole[]
  leaveTypes             LeaveCategory[]
  employees              Employee[]
  affiliations           EmployeeLocationAffiliation[] 
  shiftDefinitions       ShiftDefinition[]
  staffingRequirements   StaffingRequirement[]
  rosterPatterns         RosterPattern[]
  patternItems           PatternItem[]
  assignedPatterns       AssignedPattern[]
  shiftInstances         ShiftInstance[]
  leaveRequests          LeaveRequest[]
  shiftAdvertisements    ShiftAdvertisement[]
  shiftClaims            ShiftClaim[]
  employeeAvailabilities EmployeeAvailability[]
  managementRoles        ManagementRole[]
  createdAt              DateTime @default(now())
}

model Department {
  id               String    @id @default(uuid())
  organizationId   String
  name             String    
  archivedAt       DateTime? 
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  locations        Location[]
  managers         ManagementRole[] 
  sharedShiftTypes ShiftDefinition[]
  sharedPatterns   RosterPattern[]
}

model Location {
  id                   String    @id @default(uuid())
  organizationId       String
  departmentId         String
  name                 String    
  timezone             String    @default("UTC") 
  archivedAt           DateTime? 
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department           Department   @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  shiftDefinitions     ShiftDefinition[]
  staffingRequirements StaffingRequirement[]
  managers             ManagementRole[] 
  affiliatedStaff      EmployeeLocationAffiliation[]
  rosters              ShiftInstance[]
  patterns             RosterPattern[] 
  availability         EmployeeAvailability[] @relation("PreferredAvailabilityLocations")
}

// ==========================================
// üë• LAYER 2: PEOPLE, AFFILIATIONS & RBAC
// ==========================================
enum ManagerLevel {
  ORG
  DEPT
  LOCATION
}

model Employee {
  id                  String    @id @default(uuid())
  organizationId      String
  userId              String

  firstName      String
  lastName       String
  email          String
    
  archivedAt          DateTime? 
  user                User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  roleId              String
  role                EmployeeRole @relation(fields: [roleId], references: [id], onDelete: Restrict)
  affiliations        EmployeeLocationAffiliation[]
  managementRoles     ManagementRole[]
  shifts              ShiftInstance[]
  assignedPattern     AssignedPattern[]
  leaveRequests       LeaveRequest[]
  shiftClaims         ShiftClaim[] 
  availability        EmployeeAvailability[]
  targetManagerClaims ShiftClaim[] @relation("TargetManager")
  homeManagerClaims   ShiftClaim[] @relation("HomeManager")
  
  @@index([organizationId, userId])
}

model EmployeeLocationAffiliation {
  id             String    @id @default(uuid())
  organizationId String
  employeeId     String
  locationId     String
  isPrimary      Boolean   @default(false) 
  archivedAt     DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  location       Location     @relation(fields: [locationId], references: [id], onDelete: Restrict)

  @@unique([employeeId, locationId])
  @@index([organizationId, locationId])
  @@index([organizationId, employeeId])
}

model ManagementRole {
  id             String       @id @default(uuid())
  employeeId     String
  organizationId String
  departmentId   String?
  locationId     String?
  level          ManagerLevel 
  archivedAt     DateTime?
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department     Department?  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  location       Location?    @relation(fields: [locationId], references: [id], onDelete: Restrict)

  @@unique([employeeId, organizationId, departmentId, locationId])
}

model EmployeeRole {
  id             String    @id @default(uuid())
  organizationId String
  name           String 
  archivedAt     DateTime?
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  employees      Employee[]
  requirements   StaffingRequirement[] 
  advertisements ShiftAdvertisement[]  @relation("AdAllowedRoles")
}

// ==========================================
// ‚öôÔ∏è LAYER 3: CONFIGURATION
// ==========================================
model ShiftDefinition {
  id               String    @id @default(uuid())
  organizationId   String
  departmentId     String?   
  locationId       String?   
  archivedAt       DateTime? 
  name             String 
  startTimeMinutes Int     
  durationMinutes  Int     
  colorCode        String?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department       Department?  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  location         Location?    @relation(fields: [locationId], references: [id], onDelete: Restrict)
  requirements     StaffingRequirement[]
  shifts           ShiftInstance[] 
  patternItems     PatternItem[]
}

model StaffingRequirement {
  id                String @id @default(uuid())
  organizationId    String
  locationId        String 
  shiftDefinitionId String 
  roleId            String 
  minCount          Int
  targetCount       Int 
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  location          Location        @relation(fields: [locationId], references: [id], onDelete: Restrict)
  shiftDefinition   ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id], onDelete: Restrict)
  role              EmployeeRole    @relation(fields: [roleId], references: [id], onDelete: Restrict)
}

model LeaveCategory {
  id             String    @id @default(uuid())
  organizationId String
  name           String  
  isPaid         Boolean   @default(true)
  archivedAt     DateTime?
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  requests       LeaveRequest[]
}

// ==========================================
// üîÑ LAYER 4: AUTOMATION (Patterns)
// ==========================================
model RosterPattern {
  id             String @id @default(uuid())
  organizationId String
  departmentId   String?   
  locationId     String?   
  name           String 
  cycleLength    Int 
  items          PatternItem[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department     Department?   @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  location       Location?     @relation(fields: [locationId], references: [id], onDelete: Restrict)
  assignees      AssignedPattern[] 
}

model PatternItem {
  id                String @id @default(uuid())
  organizationId    String
  patternId         String
  dayOffset         Int 
  shiftDefinitionId String
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  shiftDefinition   ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id], onDelete: Restrict)
  pattern           RosterPattern   @relation(fields: [patternId], references: [id], onDelete: Restrict)
}

model AssignedPattern {
  id             String @id @default(uuid())
  organizationId String
  employeeId     String
  patternId      String
  anchorDate     DateTime
  startDate      DateTime
  endDate        DateTime?
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  pattern        RosterPattern @relation(fields: [patternId], references: [id], onDelete: Restrict)

  @@index([employeeId, startDate])
}

// ==========================================
// üìÖ LAYER 5: LIVE ROSTER & MARKETPLACE
// ==========================================
enum ShiftStatus {
  DRAFT
  PUBLISHED
  OPEN
  VOID
  SICK
  COMPLETED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClaimStatus {
  PENDING
  PENDING_HOME_APPROVAL
  APPROVED
  REJECTED
  WITHDRAWN
}

enum AdStatus {
  ACTIVE
  FILLED
  CANCELLED
  EXPIRED
}

model ShiftInstance {
  id                String  @id @default(uuid())
  organizationId    String
  locationId        String
  employeeId        String? 
  startTime         DateTime
  endTime           DateTime
  shiftDefinitionId String?
  shiftDefinition   ShiftDefinition? @relation(fields: [shiftDefinitionId], references: [id], onDelete: Restrict)
  status            ShiftStatus @default(PUBLISHED)
  isManual          Boolean     @default(false)
  archivedAt        DateTime?
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  location          Location            @relation(fields: [locationId], references: [id], onDelete: Restrict)
  employee          Employee?           @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  advertisement     ShiftAdvertisement? 

  @@index([organizationId, locationId, startTime, endTime])
  @@index([employeeId, startTime])
}

model LeaveRequest {
  id             String @id @default(uuid())
  organizationId String
  employeeId     String
  categoryId     String
  startDate      DateTime
  endDate        DateTime
  status         LeaveStatus @default(PENDING)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  category       LeaveCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
}

model ShiftAdvertisement {
  id                String   @id @default(uuid())
  organizationId    String
  locationId        String
  shiftInstanceId   String   @unique 
  shiftInstance     ShiftInstance @relation(fields: [shiftInstanceId], references: [id], onDelete: Restrict)
  allowedRoles      EmployeeRole[]  @relation("AdAllowedRoles")
  status            AdStatus @default(ACTIVE)
  claims            ShiftClaim[] 
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ShiftClaim {
  id                   String @id @default(uuid())
  organizationId       String
  shiftAdvertisementId String 
  advertisement        ShiftAdvertisement @relation(fields: [shiftAdvertisementId], references: [id], onDelete: Restrict)
  employeeId           String
  employee             Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  targetManagerId      String?
  targetManager        Employee? @relation("TargetManager", fields: [targetManagerId], references: [id], onDelete: SetNull)
  homeManagerId        String?
  homeManager          Employee? @relation("HomeManager", fields: [homeManagerId], references: [id], onDelete: SetNull)
  status               ClaimStatus @default(PENDING)
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([shiftAdvertisementId, employeeId])
}

model EmployeeAvailability {
  id                 String   @id @default(uuid())
  organizationId     String
  employeeId         String
  employee           Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  date               DateTime
  preference         String   @default("UNAVAILABLE") 
  preferredLocations Location[] @relation("PreferredAvailabilityLocations")
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)

  @@index([organizationId, employeeId, date])
}

// ==========================================
// üîí LAYER 6: AUDIT TRAIL
// ==========================================
model AuditLog {
  id             String   @id @default(uuid())
  timestamp      DateTime @default(now())
  organizationId String   
  actorId        String   
  action         String 
  targetId       String
  details        Json     
  
  @@index([organizationId, targetId])
  @@index([organizationId, timestamp])
  @@index([actorId, timestamp])
}