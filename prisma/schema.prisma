generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// üè• LAYER 1: HIERARCHY & TENANCY
// ==========================================

model Organization {
  id         String    @id @default(uuid())
  name       String
  settings   Json      @default("{}")
  archivedAt DateTime? // SOFT DELETE

  departments Department[]
  roles       EmployeeRole[]
  leaveTypes  LeaveCategory[]
  employees   Employee[]
  audits      AuditLog[]

  // SCOPED ACCESS
  admins Employee[] @relation("OrgAdmins")

  createdAt DateTime @default(now())
}

model Department {
  id             String    @id @default(uuid())
  organizationId String
  name           String    // e.g. "Surgery", "Emergency"
  archivedAt     DateTime? // SOFT DELETE

  organization Organization @relation(fields: [organizationId], references: [id])
  wards        Ward[]

  // SCOPED ACCESS & PEOPLE
  managers  Employee[] @relation("DeptManagers") 
  homeStaff Employee[] @relation("HomeDepartment") // For Dept-Level Locums

  sharedShiftTypes ShiftDefinition[]
}

model Ward {
  id           String    @id @default(uuid())
  departmentId String
  name         String    // e.g. "Ward 3B"
  archivedAt   DateTime? // SOFT DELETE

  department Department @relation(fields: [departmentId], references: [id])

  shiftDefinitions     ShiftDefinition[]
  staffingRequirements StaffingRequirement[]

  // SCOPED ACCESS & PEOPLE
  managers  Employee[] @relation("WardManagers") 
  homeStaff Employee[] @relation("HomeWard")     

  rosters      ShiftInstance[]
  patterns     RosterPattern[] 
  availability EmployeeAvailability[] @relation("PreferredAvailabilityWards")
}

// ==========================================
// üë• LAYER 2: PEOPLE & ROLES
// ==========================================

enum AccessLevel {
  EMPLOYEE 
  WARD_MANAGER 
  DEPT_MANAGER 
  ORG_ADMIN 
}

model Employee {
  id             String    @id @default(uuid())
  organizationId String
  userId         String?   @unique // Clerk ID

  firstName  String
  lastName   String
  email      String
  archivedAt DateTime? // SOFT DELETE

  // SECURITY SCOPE
  accessLevel AccessLevel @default(EMPLOYEE)

  // JOB TITLE
  roleId String
  role   EmployeeRole @relation(fields: [roleId], references: [id])

  // THE LOCUM SOLUTION (Optional Homes)
  // Standard = Both populated. Dept Locum = Ward is null. Global Locum = Both null.
  homeDepartmentId String?
  homeDepartment   Department? @relation("HomeDepartment", fields: [homeDepartmentId], references: [id])
  homeWardId       String?
  homeWard         Ward?       @relation("HomeWard", fields: [homeWardId], references: [id])

  // PERMISSIONS (Manager Scopes)
  managedOrganizations Organization[] @relation("OrgAdmins")
  managedDepartments   Department[]   @relation("DeptManagers")
  managedWards         Ward[]         @relation("WardManagers")

  // ROSTERING & MARKETPLACE
  shifts              ShiftInstance[]
  assignedPattern     AssignedPattern[]
  leaveRequests       LeaveRequest[]
  shiftClaims         ShiftClaim[] 
  availability        EmployeeAvailability[]
  
  // CLAIM APPROVALS (Strict Relational Ties)
  targetManagerClaims ShiftClaim[] @relation("TargetManager")
  homeManagerClaims   ShiftClaim[] @relation("HomeManager")

  organization Organization @relation(fields: [organizationId], references: [id])
  actions      AuditLog[]
}

model EmployeeRole {
  id             String @id @default(uuid())
  organizationId String
  name           String // "Registered Nurse", "HCA"

  organization   Organization          @relation(fields: [organizationId], references: [id])
  employees      Employee[]
  requirements   StaffingRequirement[] 
  advertisements ShiftAdvertisement[]  @relation("AdAllowedRoles")
}

// ==========================================
// ‚öôÔ∏è LAYER 3: CONFIGURATION (The Controls)
// ==========================================

model ShiftDefinition {
  id         String    @id @default(uuid())
  archivedAt DateTime? // SOFT DELETE

  departmentId String?
  wardId       String?

  name      String 
  startTime String 
  endTime   String 
  colorCode String?

  department Department? @relation(fields: [departmentId], references: [id])
  ward       Ward?       @relation(fields: [wardId], references: [id])

  requirements   StaffingRequirement[]
  shifts         ShiftInstance[] 
  patternItems   PatternItem[]
  advertisements ShiftAdvertisement[]
}

model StaffingRequirement {
  id String @id @default(uuid())

  wardId            String 
  shiftDefinitionId String 
  roleId            String 

  minCount    Int
  targetCount Int 

  ward            Ward            @relation(fields: [wardId], references: [id])
  shiftDefinition ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id])
  role            EmployeeRole    @relation(fields: [roleId], references: [id])
}

model LeaveCategory {
  id             String  @id @default(uuid())
  organizationId String
  name           String  // "Annual", "Sick", "Study"
  isPaid         Boolean @default(true)

  organization Organization   @relation(fields: [organizationId], references: [id])
  requests     LeaveRequest[]
  shifts       ShiftInstance[] 
}

// ==========================================
// üîÑ LAYER 4: AUTOMATION (Patterns)
// ==========================================

model RosterPattern {
  id          String @id @default(uuid())
  wardId      String
  name        String 
  cycleLength Int 

  items PatternItem[]

  ward      Ward              @relation(fields: [wardId], references: [id])
  assignees AssignedPattern[] 
}

model PatternItem {
  id        String @id @default(uuid())
  patternId String

  dayOffset         Int 
  shiftDefinitionId String

  shiftDefinition ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id])
  pattern         RosterPattern   @relation(fields: [patternId], references: [id])
}

model AssignedPattern {
  id         String @id @default(uuid())
  employeeId String
  patternId  String

  anchorDate DateTime
  startDate  DateTime
  endDate    DateTime?

  employee Employee      @relation(fields: [employeeId], references: [id])
  pattern  RosterPattern @relation(fields: [patternId], references: [id])

  @@index([employeeId, startDate])
}

// ==========================================
// üìÖ LAYER 5: LIVE ROSTER, LEAVE & MARKETPLACE
// ==========================================

enum ShiftStatus {
  DRAFT
  PUBLISHED
  OPEN      // The placeholder state
  VOID
  SICK
  COMPLETED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClaimStatus {
  PENDING
  PENDING_HOME_APPROVAL
  APPROVED
  REJECTED
  WITHDRAWN
}

enum AdStatus {
  ACTIVE
  FILLED
  CANCELLED
  EXPIRED
}

model ShiftInstance {
  id             String  @id @default(uuid())
  organizationId String
  wardId         String
  employeeId     String? // Nullable (Open Shift placeholder)

  date DateTime

  shiftDefinitionId String?
  shiftDefinition   ShiftDefinition? @relation(fields: [shiftDefinitionId], references: [id])

  startTime DateTime
  endTime   DateTime

  status   ShiftStatus @default(PUBLISHED)
  isManual Boolean     @default(false)

  leaveCategoryId String?
  leaveCategory   LeaveCategory? @relation(fields: [leaveCategoryId], references: [id])

  ward          Ward                @relation(fields: [wardId], references: [id])
  employee      Employee?           @relation(fields: [employeeId], references: [id])
  advertisement ShiftAdvertisement? // 1-to-1 link for Open Shifts

  @@index([wardId, date])
}

model LeaveRequest {
  id         String @id @default(uuid())
  employeeId String
  categoryId String

  startDate DateTime
  endDate   DateTime
  status    LeaveStatus @default(PENDING)

  employee Employee      @relation(fields: [employeeId], references: [id])
  category LeaveCategory @relation(fields: [categoryId], references: [id])
}

// THE BULLETIN BOARD
model ShiftAdvertisement {
  id                String   @id @default(uuid())
  organizationId    String
  wardId            String
  
  // Ties the Ad to the physical roster placeholder
  shiftInstanceId   String   @unique 
  shiftInstance     ShiftInstance @relation(fields: [shiftInstanceId], references: [id])

  date              DateTime
  shiftDefinitionId String
  shiftDefinition   ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id])

  // Supports multiple required roles (e.g. "RN" or "HCA")
  allowedRoles      EmployeeRole[]  @relation("AdAllowedRoles")

  status            AdStatus @default(ACTIVE)

  claims            ShiftClaim[] 

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// THE BUFFER
model ShiftClaim {
  id                   String @id @default(uuid())
  
  shiftAdvertisementId String 
  advertisement        ShiftAdvertisement @relation(fields: [shiftAdvertisementId], references: [id])
  
  employeeId           String
  employee             Employee @relation(fields: [employeeId], references: [id])

  // Strict Referential Integrity for Approvals
  targetManagerId      String?
  targetManager        Employee? @relation("TargetManager", fields: [targetManagerId], references: [id])
  
  homeManagerId        String?
  homeManager          Employee? @relation("HomeManager", fields: [homeManagerId], references: [id])

  status               ClaimStatus @default(PENDING)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([shiftAdvertisementId, employeeId])
}

// FUTURE-PROOFING: AVAILABILITY
model EmployeeAvailability {
  id           String   @id @default(uuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id])
  
  date         DateTime
  
  // "AVAILABLE" or "UNAVAILABLE"
  preference   String   @default("UNAVAILABLE") 
  
  // Optional: Specific wards they are willing to float to
  preferredWards Ward[] @relation("PreferredAvailabilityWards")

  @@index([employeeId, date])
}

// ==========================================
// üîí LAYER 6: AUDIT TRAIL
// ==========================================

model AuditLog {
  id             String   @id @default(uuid())
  timestamp      DateTime @default(now())
  organizationId String

  actorId String
  actor   Employee @relation(fields: [actorId], references: [id])

  action       String 
  targetId     String
  details      Json 
  organization Organization @relation(fields: [organizationId], references: [id])
}