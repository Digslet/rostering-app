generator client {
  provider = "prisma-client"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// üè¢ LAYER 1: HIERARCHY & TENANCY
// ==========================================

model Organization {
  id       String @id @default(uuid())
  name     String
  settings Json   @default("{}") // Global rules (e.g. "Overtime starts at 40h")

  departments Department[]
  roles       EmployeeRole[]
  leaveTypes  LeaveCategory[]
  employees   Employee[]
  audits      AuditLog[]

  createdAt DateTime @default(now())
}

model Department {
  id             String @id @default(uuid())
  organizationId String
  name           String // e.g. "Surgery", "Emergency"

  organization Organization @relation(fields: [organizationId], references: [id])
  wards        Ward[]

  // DEPARTMENT LEVEL SETTINGS
  // Managers can define shift types that apply to ALL wards in this dept
  sharedShiftTypes ShiftDefinition[]
}

model Ward {
  id           String @id @default(uuid())
  departmentId String
  name         String // e.g. "Ward 3B"

  department Department @relation(fields: [departmentId], references: [id])

  // SETTINGS: WARD LEVEL
  // Specific shift definitions (e.g. "Ward 3B Morning" might be 06:00-14:00)
  shiftDefinitions ShiftDefinition[]

  // STAFFING MATRIX (The "Base")
  // "For a Morning Shift, we need 5 Nurses and 2 Juniors"
  staffingRequirements StaffingRequirement[]

  // PEOPLE
  homeStaff Employee[] @relation("HomeWard")
  managers  Employee[] @relation("WardManagers") // SCOPED ACCESS

  rosters  ShiftInstance[]
  patterns RosterPattern[] // Reusable patterns belonging to this ward
}

// ==========================================
// üë• LAYER 2: PEOPLE & ROLES
// ==========================================

enum AccessLevel {
  EMPLOYEE // Read Only (Own Data + Peer View)
  WARD_MANAGER // Read/Write (Own Wards)
  DEPT_MANAGER // Read/Write (Own Dept)
  ORG_ADMIN // God Mode
}

model Employee {
  id             String  @id @default(uuid())
  organizationId String
  userId         String? @unique // Clerk ID

  firstName String
  lastName  String
  email     String

  // SECURITY SCOPE
  accessLevel AccessLevel @default(EMPLOYEE)

  // JOB TITLE
  roleId String
  role   EmployeeRole @relation(fields: [roleId], references: [id])

  // LOCATION
  homeWardId String?
  homeWard   Ward?   @relation("HomeWard", fields: [homeWardId], references: [id])

  // PERMISSIONS (Manager of...)
  managedWards Ward[] @relation("WardManagers")

  // ROSTERING
  shifts          ShiftInstance[]
  assignedPattern AssignedPattern[]
  leaveRequests   LeaveRequest[]

  organization Organization @relation(fields: [organizationId], references: [id])
  actions      AuditLog[]
}

model EmployeeRole {
  id             String @id @default(uuid())
  organizationId String
  name           String // "Registered Nurse", "HCA"

  organization Organization          @relation(fields: [organizationId], references: [id])
  employees    Employee[]
  requirements StaffingRequirement[] // Linked to Matrix
}

// ==========================================
// ‚öôÔ∏è LAYER 3: CONFIGURATION (The Controls)
// ==========================================

// CUSTOM SHIFT TYPES (Morning 7-3 vs Morning 6-2)
model ShiftDefinition {
  id String @id @default(uuid())

  // Scoping: Can be defined at Dept OR Ward level
  departmentId String?
  wardId       String?

  name      String // "Early Morning", "Late Shift"
  startTime String // "07:00"
  endTime   String // "15:00"
  colorCode String?

  department Department? @relation(fields: [departmentId], references: [id])
  ward       Ward?       @relation(fields: [wardId], references: [id])

  // Linked to the Matrix (Requirements)
  requirements StaffingRequirement[]
  shifts       ShiftInstance[] // Live shifts use this definition
  patternItems PatternItem[]
}

// THE WARD MATRIX ("Base")
// "For Shift X, we need Y amount of Role Z"
model StaffingRequirement {
  id String @id @default(uuid())

  wardId            String // The location
  shiftDefinitionId String // The shift (e.g. "Morning")
  roleId            String // The job (e.g. "Nurse")

  minCount    Int // "Must have at least 3"
  targetCount Int // "Ideally 5"

  ward            Ward            @relation(fields: [wardId], references: [id])
  shiftDefinition ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id])
  role            EmployeeRole    @relation(fields: [roleId], references: [id])
}

model LeaveCategory {
  id             String  @id @default(uuid())
  organizationId String
  name           String // "Annual", "Sick", "Study"
  isPaid         Boolean @default(true)

  organization Organization    @relation(fields: [organizationId], references: [id])
  requests     LeaveRequest[]
  shifts       ShiftInstance[] // For shifts marked as leave
}

// ==========================================
// ü§ñ LAYER 4: AUTOMATION (Patterns)
// ==========================================

// 1. THE BLUEPRINT (Reusable)
// e.g. "Standard 4-on-2-off" or "Weekdays Only"
model RosterPattern {
  id          String @id @default(uuid())
  wardId      String
  name        String // "4-2 Rotation"
  cycleLength Int // 6 for "4-2", 14 for "Fortnightly"

  items PatternItem[]

  ward      Ward              @relation(fields: [wardId], references: [id])
  assignees AssignedPattern[] // Many users can use this 1 pattern
}

// 2. THE ITEMS
// "Day 1 = Morning", "Day 2 = Morning"...
model PatternItem {
  id        String @id @default(uuid())
  patternId String

  dayOffset Int // 0 to (cycleLength - 1)

  // We link to the Definition, not hardcoded times
  // If Manager changes "Morning" to 6am, the pattern updates automatically.
  shiftDefinitionId String
  shiftDefinition   ShiftDefinition @relation(fields: [shiftDefinitionId], references: [id])

  pattern RosterPattern @relation(fields: [patternId], references: [id])
}

// 3. THE ASSIGNMENT (User + Blueprint + Anchor)
model AssignedPattern {
  id         String @id @default(uuid())
  employeeId String
  patternId  String

  // THE ANCHOR: The reference point for the cycle
  anchorDate DateTime

  // THE TIMELINE: When is this pattern active?
  startDate DateTime // e.g. "2024-01-01"
  endDate   DateTime? // Null = Active indefinitely. Set this when they change.

  employee Employee      @relation(fields: [employeeId], references: [id])
  pattern  RosterPattern @relation(fields: [patternId], references: [id])

  // Safety: Ensure dates don't overlap for the same user
  @@index([employeeId, startDate])
}

// ==========================================
// üìÖ LAYER 5: LIVE ROSTER & LEAVE
// ==========================================

model ShiftInstance {
  id             String  @id @default(uuid())
  organizationId String
  wardId         String
  employeeId     String? // Nullable (Open Shift)

  date DateTime

  // DEFINITION (The "Expected" Times)
  shiftDefinitionId String?
  shiftDefinition   ShiftDefinition? @relation(fields: [shiftDefinitionId], references: [id])

  // ACTUAL TIMES (Can be overridden per shift)
  startTime DateTime
  endTime   DateTime

  // STATUS
  status   String  @default("PUBLISHED") // PUBLISHED, VOID, SICK
  isManual Boolean @default(false)

  // LEAVE OVERRIDE
  leaveCategoryId String? // If set, this is a Leave Shift
  leaveCategory   LeaveCategory? @relation(fields: [leaveCategoryId], references: [id])

  ward     Ward      @relation(fields: [wardId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])

  @@index([wardId, date])
}

model LeaveRequest {
  id         String @id @default(uuid())
  employeeId String
  categoryId String

  startDate DateTime
  endDate   DateTime
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED

  employee Employee      @relation(fields: [employeeId], references: [id])
  category LeaveCategory @relation(fields: [categoryId], references: [id])
}

// ==========================================
// üîí LAYER 6: AUDIT TRAIL
// ==========================================

model AuditLog {
  id             String   @id @default(uuid())
  timestamp      DateTime @default(now())
  organizationId String

  actorId String
  actor   Employee @relation(fields: [actorId], references: [id])

  action       String // "CREATE_PATTERN", "UPDATE_MATRIX"
  targetId     String
  details      Json // Full diff
  organization Organization @relation(fields: [organizationId], references: [id])
}
